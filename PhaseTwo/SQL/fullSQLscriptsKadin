SQL Script Phase 2
-- JUST TO NOTE, I used CLAUDE AI to help make these SQL commands through prompts specifying what I wanted to do. For example: To clean the location data and 
-= find the 'REMOTE' in the location string and to strip the city name as well, I prompted it to alter the table to add a column and then get a method to do this.


USE TEST;


# This is all for creating the Job and Employer Tables using Data scraped from JobsInMaine
CREATE TABLE Location_Lookup(
zip_code CHAR(5) PRIMARY KEY,
city VARCHAR(100),
county VARCHAR(100)
);

CREATE TABLE Jobs_Temp(
job_title VARCHAR(200),
employer_website VARCHAR(255),
employer_name VARCHAR(200),
location VARCHAR(200),
salary_min VARCHAR(20),
salary_max VARCHAR(20),
posted_at DATETIME,
application_url VARCHAR(255)
);

CREATE TABLE Jobs(
job_id INT PRIMARY KEY AUTO_INCREMENT,
employer_id INT,
recruiter_id INT,
application_url VARCHAR(300),
job_description VARCHAR(2000),
job_title VARCHAR(200),
salary_min VARCHAR(20),
salary_max VARCHAR(20),
remote_pref VARCHAR(10),
location_raw VARCHAR(200),
city VARCHAR(100),
county VARCHAR(100),
zip_code CHAR(5),
posted_at DATETIME,
expires_at DATETIME,
estimated_start_date DATETIME,
is_expired BOOL
);

CREATE TABLE Employer(
employer_id INT PRIMARY KEY AUTO_INCREMENT,
employer_name VARCHAR(200),
employer_culture VARCHAR(1000),
employer_website VARCHAR(255),
employer_industry CHAR(50)
);

ALTER TABLE jobs_temp ADD COLUMN city_name VARCHAR(100);

-- Extract city names from the messy location strings
SET SQL_SAFE_UPDATES = 0;

-- Now run your UPDATE
UPDATE jobs_temp 
SET city_name = TRIM(
    CASE 
        WHEN location LIKE 'Remote (%' THEN 
            SUBSTRING_INDEX(SUBSTRING_INDEX(location, '(', -1), ',', 1)
        WHEN location REGEXP '[0-9]{5}' THEN 
            TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(location, ',', -2), ',', 1))
        ELSE 
            SUBSTRING_INDEX(location, ',', 1)
    END
);

-- Re-enable safe mode after (optional)
SET SQL_SAFE_UPDATES = 1;

INSERT INTO employer (employer_name, employer_website)
SELECT DISTINCT 
    employer_name, 
    employer_website
FROM jobs_temp
WHERE employer_name IS NOT NULL
ORDER BY employer_name;


INSERT INTO jobs (
    job_title, 
    salary_min, 
    salary_max, 
    remote_pref,
    location_raw, 
    city, 
    county, 
    zip_code, 
    posted_at, 
    application_url, 
    employer_id
)
SELECT 
    jt.job_title,
    jt.salary_min,
    jt.salary_max,
    CASE 
        WHEN jt.location LIKE 'Remote%' THEN 'Remote'
        ELSE 'Office'
    END as remote_pref,
    jt.location,
    ll.city,
    ll.county,
    ll.zip_code,
    jt.posted_at,
    jt.application_url,
    e.employer_id
FROM jobs_temp jt
LEFT JOIN employer e 
    ON jt.employer_name = e.employer_name 
    AND jt.employer_website = e.employer_website
LEFT JOIN location_lookup ll 
    ON jt.city_name = ll.city;

ALTER TABLE Jobs
    MODIFY application_url VARCHAR(300) NOT NULL,
    MODIFY job_title VARCHAR(200) NOT NULL,
    MODIFY remote_pref VARCHAR(10) NOT NULL,
    MODIFY posted_at DATETIME NOT NULL
;

ALTER TABLE Employer
    MODIFY employer_name VARCHAR(200) NOT NULL
    ;


# More work on the Employer and Job tables, also USER and JobApplication


-- taken from Jered's work in GitHub
CREATE TABLE IF NOT EXISTS USER(
  User_ID INT NOT NULL AUTO_INCREMENT,
  First_Name VARCHAR(50) NOT NULL,
  Last_Name VARCHAR(50) NOT NULL,
  Middle_Initial CHAR(1) DEFAULT NULL,
  Email VARCHAR(100) NOT NULL,
  Phone VARCHAR(15) DEFAULT NULL,
  City VARCHAR(50) DEFAULT NULL,
  County VARCHAR(50) NOT NULL,
  Zip_Code CHAR(5) DEFAULT NULL,
  PRIMARY KEY (User_ID),
  UNIQUE KEY (Email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

ALTER TABLE USER
ADD COLUMN employer_id INT;

ALTER TABLE USER
ADD CONSTRAINT fk_user_employer
	FOREIGN KEY (employer_id)
    REFERENCES employer(employer_id);

ALTER TABLE USER
ADD COLUMN recruiter_id INT;

ALTER TABLE USER
ADD UNIQUE (recruiter_id);
-- this was generated by Sonnet 4.5
CREATE TABLE IF NOT EXISTS Job_Application(
    job_id INT,
    user_id INT,
    applied_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    referred_by INT NULL,
    status ENUM('External', 'Received', 'Under_Review', 'Interview_Scheduled', 'Rejected', 'Accepted') 
        DEFAULT 'Received',
    
    -- Composite primary key (one application per user per job)
    PRIMARY KEY (job_id, user_id),
    
    -- Foreign key to Jobs table
    CONSTRAINT fk_application_job
    FOREIGN KEY (job_id) REFERENCES Jobs(job_id)
    ON DELETE CASCADE  -- If job deleted, remove applications
    ON UPDATE CASCADE,
    
    -- Foreign key to User table
    CONSTRAINT fk_application_user
    FOREIGN KEY (user_id) REFERENCES User(user_id)
    ON DELETE CASCADE  -- If user deleted, remove their applications
    ON UPDATE CASCADE,
    
    -- Foreign key for referral (self-referencing User table)
    CONSTRAINT fk_application_referrer
    FOREIGN KEY (referred_by) REFERENCES User(user_id)
    ON DELETE SET NULL  -- If referrer deleted, keep application but clear referral
    ON UPDATE CASCADE
);

ALTER TABLE Jobs
ADD CONSTRAINT fk_jobs_employer
    FOREIGN KEY (employer_id) REFERENCES Employer(employer_id);

ALTER TABLE Jobs
ADD CONSTRAINT fk_jobs_recruiter
    FOREIGN KEY (recruiter_id) REFERENCES USER(recruiter_id);



# Procedures for job_application, job and employer table 

USE TEST;

DELIMITER $$

CREATE PROCEDURE add_employer(
    IN p_employer_name VARCHAR(200),
    IN p_employer_culture VARCHAR(1000),
    IN p_employer_website VARCHAR(255),
    IN p_employer_industry CHAR(50)
)
BEGIN
    INSERT INTO Employer (employer_name, employer_culture, employer_website, employer_industry)
    VALUES (p_employer_name, p_employer_culture, p_employer_website, p_employer_industry);
END $$

DELIMITER ;

DELIMITER $$

CREATE PROCEDURE update_employer(
    IN p_employer_id INT,
    IN p_employer_name VARCHAR(200),
    IN p_employer_culture VARCHAR(1000),
    IN p_employer_website VARCHAR(255),
    IN p_employer_industry CHAR(50)
)
BEGIN
    UPDATE Employer
    SET 
        employer_name = p_employer_name,
        employer_culture = p_employer_culture,
        employer_website = p_employer_website,
        employer_industry = p_employer_industry
    WHERE employer_id = p_employer_id;
END $$

DELIMITER ;

DELIMITER $$

CREATE PROCEDURE delete_employer(IN p_employer_id INT)
BEGIN
    DELETE FROM Employer
    WHERE employer_id = p_employer_id;
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE add_job(
    IN p_employer_id INT,
    IN p_recruiter_id INT,
    IN p_application_url VARCHAR(300),
    IN p_job_description VARCHAR(2000),
    IN p_job_title VARCHAR(200),
    IN p_salary_min VARCHAR(20),
    IN p_salary_max VARCHAR(20),
    IN p_remote_pref VARCHAR(10),
    IN p_location_raw VARCHAR(200),
    IN p_city VARCHAR(100),
    IN p_county VARCHAR(100),
    IN p_zip_code CHAR(5),
    IN p_posted_at DATETIME,
    IN p_expires_at DATETIME,
    IN p_estimated_start_date DATETIME,
    IN p_is_expired BOOL
)
BEGIN
    INSERT INTO Jobs (
        employer_id, recruiter_id, application_url, job_description, job_title,
        salary_min, salary_max, remote_pref, location_raw, city, county, zip_code,
        posted_at, expires_at, estimated_start_date, is_expired
    )
    VALUES (
        p_employer_id, p_recruiter_id, p_application_url, p_job_description, p_job_title,
        p_salary_min, p_salary_max, p_remote_pref, p_location_raw, p_city, p_county, p_zip_code,
        p_posted_at, p_expires_at, p_estimated_start_date, p_is_expired
    );
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE update_job(
    IN p_job_id INT,
    IN p_employer_id INT,
    IN p_recruiter_id INT,
    IN p_application_url VARCHAR(300),
    IN p_job_description VARCHAR(2000),
    IN p_job_title VARCHAR(200),
    IN p_salary_min VARCHAR(20),
    IN p_salary_max VARCHAR(20),
    IN p_remote_pref VARCHAR(10),
    IN p_location_raw VARCHAR(200),
    IN p_city VARCHAR(100),
    IN p_county VARCHAR(100),
    IN p_zip_code CHAR(5),
    IN p_posted_at DATETIME,
    IN p_expires_at DATETIME,
    IN p_estimated_start_date DATETIME,
    IN p_is_expired BOOL
)
BEGIN
    UPDATE Jobs
    SET
        employer_id = p_employer_id,
        recruiter_id = p_recruiter_id,
        application_url = p_application_url,
        job_description = p_job_description,
        job_title = p_job_title,
        salary_min = p_salary_min,
        salary_max = p_salary_max,
        remote_pref = p_remote_pref,
        location_raw = p_location_raw,
        city = p_city,
        county = p_county,
        zip_code = p_zip_code,
        posted_at = p_posted_at,
        expires_at = p_expires_at,
        estimated_start_date = p_estimated_start_date,
        is_expired = p_is_expired
    WHERE job_id = p_job_id;
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE delete_job(IN p_job_id INT)
BEGIN
    DELETE FROM Jobs
    WHERE job_id = p_job_id;
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE add_job_application(
    IN p_job_id INT,
    IN p_user_id INT,
    IN p_referred_by INT,
    IN p_status ENUM('External', 'Received', 'Under_Review', 'Interview_Scheduled', 'Rejected', 'Accepted')
)
BEGIN
    INSERT INTO Job_Application (job_id, user_id, referred_by, status)
    VALUES (p_job_id, p_user_id, p_referred_by, p_status);
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE update_job_application(
    IN p_job_id INT,
    IN p_user_id INT,
    IN p_referred_by INT,
    IN p_status ENUM('External', 'Received', 'Under_Review', 'Interview_Scheduled', 'Rejected', 'Accepted')
)
BEGIN
    UPDATE Job_Application
    SET 
        referred_by = p_referred_by,
        status = p_status
    WHERE job_id = p_job_id
      AND user_id = p_user_id;
END $$

DELIMITER ;


DELIMITER $$

CREATE PROCEDURE delete_job_application(
    IN p_job_id INT,
    IN p_user_id INT
)
BEGIN
    DELETE FROM Job_Application
    WHERE job_id = p_job_id
      AND user_id = p_user_id;
END $$

DELIMITER ;


